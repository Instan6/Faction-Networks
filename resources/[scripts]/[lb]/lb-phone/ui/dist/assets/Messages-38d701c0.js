import{u as L,r as u,j as d,m as J,a as e,F as de,L as i,v as y,C as _,a0 as ze,a1 as Ve,b as q,d as ge,i as j,t as x,P as z,a2 as Ke,H as Fe,N as Qe,a3 as fe,a4 as Ye,S as He,Q as ve,A as se,I as Je,g as Se,a5 as et,l as Ge,a6 as tt,a7 as je,a8 as Te,a9 as De,aa as We,ab as at,K as Ie,ac as Ce,w as H,ad as Re,x as ke,ae as Le,af as st,X as we,ag as Ue,q as _e,R as nt,T as rt,ah as Oe,s as it,ai as lt,h as re,aj as ot,B as ct,D as dt,ak as ut,al as mt,z as St,W as ht,am as Et,f as ft}from"./index-596d2424.js";import{A as vt,g as gt}from"./audioRecorder-d2e44187.js";import{g as At,a as Pt,b as Mt,i as pt,M as pe,A as $e,c as Nt,T as Ct,d as bt,e as Tt,L as xe,C as It,f as wt}from"./Maps-0cd6ad2e.js";const Be=t=>{if(t)return/<!SENT-LOCATION-X=(-?\d*\.?\d*)Y=(-?\d*\.?\d*)!>/.test(t)},be=t=>{if(t)return t==="<!CALL-NO-ANSWER!>"},Ot=t=>{if(t)return/<!AUDIO-MESSAGE-IMAGE="(.*)"-AUDIO="(.*)"-DURATION="(.*)"!>/.test(t)},yt=t=>{if(t.length===0)return!0;if(t)return!/^<!.*!>$/.test(t)},Gt=({onEnd:t,close:r})=>{const g=L(q),[A,C]=u.useState(!1),[p,o]=u.useState(0),[a,T]=u.useState(null),v=u.useRef(null);if(!g.EnableVoiceMessages)return null;u.useEffect(()=>{if(!A)return;let l=setInterval(()=>{o(S=>S+1)},1e3);return()=>clearInterval(l)},[A]),u.useEffect(()=>(v.current=new vt,()=>{v.current&&v.current.stop()}),[]);const G=l=>{let S=Math.floor(l/60),h=l%60;return`${S}:${h<10?"0":""}${h}`},s=async l=>{const S=await gt(new Blob(l),25,7,324,55,3);T(S)};return d(J.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:0},transition:{duration:.2,ease:"easeInOut"},className:"audioMessage-container",children:[e("div",{className:"close",onClick:r}),d("div",{className:"audioMessage-wrapper",children:[d("div",{className:"duration",children:[A&&e("div",{className:"dot"}),G(p)]}),e("div",{className:"content",children:A?e(de,{children:a!=null&&a.base64?e("img",{src:a==null?void 0:a.base64}):i("APPS.MESSAGES.LOADING")}):i("APPS.MESSAGES.START_RECORDING")}),e("div",{className:"button","data-recording":A,onClick:()=>{var S;if(!((S=navigator.mediaDevices)!=null&&S.getUserMedia)||!(v!=null&&v.current))return y("error","No media devices found!");let l=v.current;A?l.stop().then(h=>{if(!h){o(0),C(c=>!c),_.PopUp.set({title:i("APPS.MESSAGES.EMPTY_RECORDING.TITLE"),description:i("APPS.MESSAGES.EMPTY_RECORDING.DESCRIPTION"),buttons:[{title:i("APPS.MESSAGES.EMPTY_RECORDING.OK")}]});return}t(h),C(c=>!c)}):(l.start(100,s),C(h=>!h))},children:A?e(ze,{}):e(Ve,{})})]})]})},Dt=({paymentAmount:t,setPaymentAmount:r,close:g})=>{const{User:A}=u.useContext(ue),C=L(q),[p]=A,[o,a]=u.useState(0),[T,v]=u.useState(4);let G={0:3,11:2.75,14:2.2};return u.useEffect(()=>{o===0&&v(G[0]);let s=0;for(let l=0;l<Object.keys(G).length;l++)o>=parseInt(Object.keys(G)[l])&&(s=G[Object.keys(G)[l]]);v(s)},[o]),u.useEffect(()=>{r(o)},[o]),d(J.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:0},transition:{duration:.2,ease:"easeInOut"},className:"payment-container",children:[e("div",{className:"close",onClick:g}),d("div",{className:"payment-wrapper",children:[e("div",{className:"button",onClick:()=>t>0&&a(s=>s-1),children:"-"}),e("div",{className:"amount",children:e(ge,{type:"number",value:t,style:{fontSize:`${T}rem`},onChange:s=>{if(s.target.value.match(/^[0-9]+$/)&&parseFloat(s.target.value)>0&&parseFloat(s.target.value)<(C.MaxTransferAmount??Number.MAX_SAFE_INTEGER))a(parseFloat(s.target.value));else return s.preventDefault()}})}),e("div",{className:"button",onClick:()=>a(s=>s+1),children:"+"})]}),d("div",{className:"payment-buttons",children:[e("div",{className:"button",onClick:()=>Rt(t,p.number),children:i("APPS.MESSAGES.PAY.REQUEST")}),e("div",{className:"button",onClick:()=>qe(t,{id:p.id,name:p.name,number:p.number}),children:i("APPS.MESSAGES.PAY.SEND")})]})]})},qe=(t,r)=>{var g;if(q.value.EnableMessagePay&&!(!t&&t<=0)){if(t>(((g=q.value)==null?void 0:g.MaxTransferAmount)??Number.MAX_SAFE_INTEGER))return y("error","Amount is too high");_.PopUp.set({title:i("APPS.MESSAGES.PAY.SEND_TITLE").format({amount:q.value.CurrencyFormat.replace("%s",t.toString())}),description:i("APPS.MESSAGES.PAY.SEND_DESCRIPTION").format({amount:q.value.CurrencyFormat.replace("%s",t.toString()),name:r.name??j(r.number)}),buttons:[{title:i("APPS.MESSAGES.PAY.SEND_BUTTON_CANCEL")},{title:i("APPS.MESSAGES.PAY.SEND_BUTTON_SEND"),cb:()=>{x("Wallet",{action:"sendPayment",number:r.number,amount:t},{success:!0}).then(A=>{var C,p;if(A.success){let o={id:r.id,sender:(p=(C=z)==null?void 0:C.PhoneNumber)==null?void 0:p.value,content:`<!SENT-PAYMENT-${t}!>`,attachments:[],timestamp:Date.now()};I.set([...I.value,o])}else{y("error","Failed to send payment "+JSON.stringify(A)),setTimeout(()=>{_.PopUp.set({title:i(`APPS.WALLET.${A.reason}.TITLE`),description:i(`APPS.WALLET.${A.reason}.DESCRIPTION`),buttons:[{title:i("APPS.WALLET.OK")}]})},500);return}})}}]})}},Rt=(t,r)=>{var A,C;if(!q.value.EnableMessagePay||!t&&t<=0)return;let g={sender:(C=(A=z)==null?void 0:A.PhoneNumber)==null?void 0:C.value,content:`<!REQUESTED-PAYMENT-${t}!>`,attachments:[],timestamp:Date.now()};x("Messages",{action:"sendMessage",number:r,content:g.content,attachments:[]},{messageId:Math.floor(Math.random()*1e3).toString()}).then(p=>{if(!p)return I.set([...I.value,{...g,delivered:!1}]);I.set([...I.value,{...g,id:p.messageId}])})},Xe={Messagelist:[{id:"1",number:"4802940940",name:"Loaf Scripts",unread:!0,lastMessage:"Sure Thing!",messages:[{sender:"4802940940",content:"Sure Thing!",timestamp:Date.now()-1e3*60*60*2},{sender:"1234567890",content:"Ready to release more products?",timestamp:Date.now()-1e3*60*60*2-1e3*60*5},{sender:"4802940940",content:"Hey!",timestamp:Date.now()-1e3*60*60*2-1e3*60*10}],timestamp:Date.now()-1e3*60*60*2},{id:"2",name:"Office Chat",unread:!0,lastMessage:"is the meeting at 8pm?",timestamp:Date.now()-1e3*60*60*4,isGroup:!0,members:[{number:"4802940940",name:"Loaf Scripts",isOwner:!1},{number:"1566444151",name:"Peter",isOwner:!1},{number:"2051440412",name:"Peter",isOwner:!1},{number:"2051440412",isOwner:!1}],messages:[{sender:"4802940940",content:"is the meeting at 8pm?",timestamp:Date.now()-1e3*60*60*4},{sender:"1566444151",content:"please confirm the time",timestamp:Date.now()-1e3*60*60*4-1e3*60*5},{sender:"2051440412",content:"Hey everyone, please make sure to be on time for the meeting",timestamp:Date.now()-1e3*60*60*4-1e3*60*10}]},{id:"3",number:"4802940963",unread:!1,lastMessage:"yeah i dont know whats going on, it was super weird. i think i might have to go to the doctor",timestamp:Date.now()-1e3*60*60*2*24,messages:[{sender:"4802940940",content:"yeah i dont know whats going on, it was super weird. i think i might have to go to the doctor",timestamp:Date.now()-1e3*60*60*2*24},{sender:"1234567890",content:"i hope you feel better soon",timestamp:Date.now()-1e3*60*60*2*24-1e3*60*5},{sender:"4802940940",content:"still sick :(",timestamp:Date.now()-1e3*60*60*2*24-1e3*60*10}]},{id:"4",number:"4802940942",unread:!0,lastMessage:"see you!",timestamp:Date.now()-1e3*60*60*2*24*2,messages:[{sender:"4802940942",content:"<!SENT-LOCATION-X=400.2Y=-1550.3!>",timestamp:Date.now()-1e3*60*60*2*24},{sender:"4802940942",content:`see you!

heres the location`,timestamp:Date.now()-1e3*60*60*2*24*2},{sender:"1234567890",content:"ofcourse, i will be there",timestamp:Date.now()-1e3*60*60*2*24*2-1e3*60*3},{sender:"4802940942",content:"hey buddy, still on for tomorrow?",timestamp:Date.now()-1e3*60*60*2*24*2-1e3*60*3}]}]};function kt({location:t}){var l,S,h;const r=L(q),g=L($e),[A,C]=u.useState("losSantos"),p=At(r==null?void 0:r.CustomMaps),o=Pt(r==null?void 0:r.CustomMaps),a=Mt(A,r==null?void 0:r.CustomMaps),T={minZoom:0,maxZoom:6},G=o.mapTypes[A]||T,s=()=>A===pe.LOS_SANTOS?xe:A===pe.CAYO_PERICO?It:r!=null&&r.CustomMaps&&r.CustomMaps.length>0&&r.CustomMaps.findIndex((w,U)=>`customMap${U}`===A)!==-1?wt(A,r.CustomMaps):xe;return u.useEffect(()=>{r!=null&&r.CustomMaps&&r.CustomMaps.length>0?C("customMap0"):C(pt({x:t[0],y:t[1]},r==null?void 0:r.CustomMaps)?pe.LOS_SANTOS:pe.CAYO_PERICO)},[t,r==null?void 0:r.CustomMaps]),u.useEffect(()=>{if(!(r!=null&&r.CustomMaps)||r.CustomMaps.length===0)return;const w=(()=>{var R;const U=r.CustomMaps.findIndex((V,O)=>`customMap${O}`===A);return U!==-1?((R=r.CustomMaps[U].styles)==null?void 0:R.map(O=>O.name))||["render","game","print"]:["render","game","print"]})();w.includes(g)||($e.set(w[0]),Ke.value||localStorage.setItem("lb-active-map-type",w[0]))},[A,r==null?void 0:r.CustomMaps,g]),u.useEffect(()=>{setTimeout(()=>{const c=document.querySelector(".leaflet-control-attribution.leaflet-control a");c&&(c.removeAttribute("href"),c.onclick=()=>{window.invokeNative("openUrl","https://leafletjs.com/")})},500)},[]),e("div",{className:"mapscomponent-wrapper",children:d(Nt,{className:"map",crs:s(),style:{backgroundColor:((l=o.backgrounds)==null?void 0:l[g])||"#0d2b4f"},center:[t[0],t[1]],zoom:4,scrollWheelZoom:!1,zoomControl:!1,doubleClickZoom:!1,dragging:!1,bounceAtZoomLimits:!0,boxZoom:!1,maxBoundsViscosity:.95,maxBounds:a,attributionControl:!1,preferCanvas:!0,children:[e(Ct,{url:((h=(S=p[A])==null?void 0:S.tileServer)==null?void 0:h.replace("{layer}",g))||"",minZoom:G.minZoom,maxZoom:G.maxZoom,maxNativeZoom:G.maxZoom,noWrap:!0},`${A}-${g}`),e(bt,{position:t,icon:Tt()})]})})}const I=Ie([]);function Lt(){const{User:t,View:r,UnreadMessages:g}=u.useContext(ue),A=L(z.Settings),C=L(q),p=L(z.PhoneNumber),o=L(se),[a,T]=t,[v,G]=r,[s,l]=g,S=L(I),h=L(_.Emoji),c=L(_.Gif),[w,U]=u.useState(!1),[R,V]=u.useState(null),[O,ee]=u.useState(!1),[k,ne]=u.useState(!1),[K,P]=u.useState(0),[b,m]=u.useState(null),f=u.useRef(null),D=u.useRef(0),N=u.useRef(!1),[M,W]=u.useState({content:"",attachments:[]});if(!a)return null;u.useEffect(()=>{if(!Fe("Messages")||!(a!=null&&a.id))return;I.set([]),B.current=0;const n=(E=void 0,$=0)=>{var le;if($>=10)return Promise.resolve();const Y={action:"getMessages",id:a==null?void 0:a.id};return E!==void 0&&(Y.lastId=E),x("Messages",Y,((le=Xe.Messagelist.find(Z=>Z.id===a.id))==null?void 0:le.messages)??[]).then(Z=>{if(!Z||Z.length===0)return;const oe=Z.filter(te=>{const Ne=be(te.content),Ze=te.sender===p;return!(Ne&&Ze)}),ye=I.value||[],Me=[...oe.reverse(),...ye];if(I.set(Me),B.current=Me.length,oe.length<10&&Z.length>=25&&$<10-1){const te=Z[Z.length-1],Ne=te!=null&&te.id?typeof te.id=="number"?te.id:parseInt(te.id):void 0;return n(Ne,$+1)}})};return n(),()=>{I.set([]),B.current=0}},[o==null?void 0:o.active,a==null?void 0:a.id]);const ie=()=>{var E,$;if(M.content.length<=0&&M.attachments.length<=0&&!b)return y("info","Message is empty, returning");let n={sender:p,timestamp:Date.now(),id:a.id,content:M.content,attachments:M.attachments};if(!yt(M.content))return y("error","Message contains invalid characters, returning",M.content);if(!Ce())return I.set([...I.value,{...n,delivered:!1}]);if(($=(E=H.APPS.PHONE.blockedNumbers)==null?void 0:E.value)!=null&&$.includes(a.number))return I.set([...I.value,{...n,delivered:!1}]);if(b){if(N.current)return;N.current=!0,Re("Image",b.waves.message).then(F=>{Re("Audio",b.blob).then(Y=>{n.content=`<!AUDIO-MESSAGE-IMAGE="${F}"-AUDIO="${Y}"-DURATION="${b.duration}"!>`,x("Messages",{action:"sendMessage",number:a.number,content:n.content,id:a.id},{messageId:Math.random().toString(36).substring(7)}).then(le=>{le&&Ce()?I.set([...I.value,{...n,id:le.messageId}]):I.set([...I.value,{...n,delivered:!1}]),N.current=!1,m(null)})}).catch(Y=>{console.error("Failed to upload voice message audio",Y),N.current=!1})}).catch(F=>{console.error("Failed to upload voice message image",F),N.current=!1});return}x("Messages",{action:"sendMessage",number:a.number,content:M.content,attachments:M.attachments,id:a.id},{messageId:Math.random().toString(36).substring(7)}).then(F=>{F?(I.set([...I.value,{...n,id:F.messageId}]),m(null)):I.set([...I.value,{...n,delivered:!1}]),W({content:"",attachments:[]}),f.current&&(f.current.value=""),y("info","Updating recent message cache state"),H.APPS.MESSAGES.messages.set(H.APPS.MESSAGES.messages.value.map(Y=>Y.id===a.id?{...Y,timestamp:new Date().getTime(),lastMessage:n.content.length>0&&n.content,unread:!1,deleted:!1}:Y))})},he=()=>{_.PopUp.set({title:i("APPS.MESSAGES.SEND_LOCATION_POPUP.TITLE"),description:i("APPS.MESSAGES.SEND_LOCATION_POPUP.TEXT"),buttons:[{title:i("APPS.MESSAGES.SEND_LOCATION_POPUP.CANCEL")},{title:i("APPS.MESSAGES.SEND_LOCATION_POPUP.SEND"),cb:()=>{x("Maps",{action:"getCurrentLocation"},{x:0,y:0}).then(n=>{if(!n)return;let E={id:a.id,sender:p,content:`<!SENT-LOCATION-X=${ke(n.x,2)}Y=${ke(n.y,2)}!>`,attachments:[],timestamp:Date.now()};x("Messages",{action:"sendMessage",number:a.number,content:E.content,attachments:E.attachments,id:E.id},{messageId:Math.random().toString(36).substring(7)}).then($=>{if(!$)return I.set([...I.value,{...E,delivered:!1}]);I.set([...I.value,{...E,id:$.messageId}])})})}}]})},X=u.useRef(!1),B=u.useRef(0),Q=u.useRef(null),{handleScroll:me}=Qe({fetchData:()=>{var n;return x("Messages",{action:"getMessages",id:a.id,lastId:(n=I.value[0])==null?void 0:n.id})},onDataFetched:n=>{if(!n||n.length===0){X.current=!1;return}const E=Q.current||document.querySelector(".message-container");E?(D.current=E.scrollHeight,X.current=!0):X.current=!1;const $=I.value||[],Y=[...n.reverse(),...$];I.set(Y)},isReversed:!0,perPage:25,fetchCooldown:500});u.useLayoutEffect(()=>{const n=S.length>B.current;if(!X.current||!n){B.current=S.length;return}if(B.current===0){B.current=S.length,X.current=!1;return}const E=Q.current||document.querySelector(".message-container");if(!E){X.current=!1,B.current=S.length;return}const $=E.scrollTop,F=D.current;let Y=0;const le=5,Z=()=>{const oe=Q.current||document.querySelector(".message-container");if(!oe||oe!==E){X.current=!1,B.current=S.length;return}const Ee=oe.scrollHeight-F;if(Ee===0&&Y<le){Y++,requestAnimationFrame(Z);return}if(Ee>0&&Ee<1e4){const Me=$+Ee;oe.scrollTop=Me}X.current=!1,B.current=S.length};Z()},[S]),fe("messages:newMessage",n=>{a.id===n.channelId&&I.set([...I.value,{...n,timestamp:Date.now()}])},{waitUntilService:!0}),fe("messages:renameGroup",n=>{a.id===n.channelId&&T(E=>({...E,name:n.name}))},{waitUntilService:!0}),fe("messages:messageDeleted",n=>{if(y("info","messages:messageDeleted triggered",n),!n)return y("error","Did not get any data from messages:messageDeleted, returning");I.set(I.value.filter(E=>E.id!==n.messageId))},{waitUntilService:!0}),fe("messages:removeMember",n=>{a.id===n.channelId&&n.number===p&&(G("userlist"),T(null),I.set([]),B.current=0)},{waitUntilService:!0});const Ae=Ye(n=>{if(!C.DeleteMessages)return y("error","Config.DeleteMessages is set to false");let E=n.target;for(;!E.classList.contains("message");)E=E.parentElement;let $=E.getAttribute("data-id");if(!$)return y("error","Failed to get message id when longpressing");isNaN($)||($=parseInt($));let F=S.find(Y=>Y.id===$);if(!F)return y("error","Failed to find message with id",$);F.sender===p&&(Be(F.content)||Pe(F.content)||be(F.content)||_.ContextMenu.set({buttons:[{title:i("APPS.MESSAGES.DELETE"),color:"red",cb:()=>{x("Messages",{action:"deleteMessage",channel:a.id,id:$}).then(Y=>{if(!Y)return y("error","Failed to delete message")})}}]}))}),Pe=n=>!n||!C.EnableMessagePay?!1:/<!SENT-PAYMENT-(\d*)!>/.test(n)?!0:!!/<!REQUESTED-PAYMENT-(\d*)!>/.test(n);return e(de,{children:d(J.div,{...He("right","message",.2),className:"animation-container",children:[d(ve,{children:[w&&e(xt,{setShow:U,setShowUserInfo:V,sendLocation:he,setData:T,data:a}),R&&e($t,{setShow:V,user:a!=null&&a.isGroup?R:a})]}),d("div",{className:"message-header",children:[d("div",{className:"back",onClick:()=>{var n;G("userlist"),T(null),I.set([]),B.current=0,(n=se.value.active)!=null&&n.data&&se.patch({active:{name:"Messages",data:null}}),a.unread&&(x("Messages",{action:"markRead",id:a.id}),l(E=>E-1))},children:[e(Je,{}),s>0&&e("span",{className:"back-title",children:s})]}),d("div",{className:"user",onClick:()=>{a!=null&&a.isGroup?U(!0):V(!0)},children:[a!=null&&a.isGroup?e("div",{className:"group-avatar",style:{backgroundImage:a!=null&&a.avatar?`url(${a.avatar})`:null},children:!(a!=null&&a.avatar)&&d(de,{children:[a.members.sort((n,E)=>n.name&&E.name?n.name.localeCompare(E.name):n.name?-1:E.name?1:0).sort((n,E)=>(n.avatar?1:-1)-(E.avatar?1:-1)).slice(0,5).map((n,E)=>e("div",{className:"avatar","data-hasavatar":(n==null?void 0:n.avatar)!==void 0,style:{backgroundImage:n!=null&&n.avatar?`url(${n.avatar})`:null,zIndex:a.members.length-E},children:n.name?!(n!=null&&n.avatar)&&Se(n.name):e("img",{src:`./assets/img/avatar-placeholder-${A.display.theme}.svg`,alt:""})},E)),a.members.length===0&&e("img",{src:`./assets/img/avatar-placeholder-${A.display.theme}.svg`,alt:""})]})}):e("div",{className:"avatar","data-hasavatar":(a==null?void 0:a.avatar)!==void 0,style:{backgroundImage:a!=null&&a.avatar?`url(${a.avatar})`:null},children:a.name?!(a!=null&&a.avatar)&&Se(a.name):e("img",{src:`./assets/img/avatar-placeholder-${A.display.theme}.svg`,alt:""})}),e("div",{className:"name",children:a!=null&&a.isGroup?a.name??`${a.members.length===0?1:a.members.length} ${i("APPS.MESSAGES.PEOPLE")}`:a.name??j(a.number)})]}),d("div",{className:"buttons","data-hidden":a==null?void 0:a.isGroup,children:[e(et,{onClick:()=>{a!=null&&a.isGroup||Ge({number:a.number})}}),e(tt,{onClick:()=>{a!=null&&a.isGroup||Ge({number:a.number,videoCall:!0})}})]})]}),e("div",{ref:Q,className:"message-container",onScroll:me,style:k||O?{height:"48%"}:{},children:e("div",{className:"message-body",children:S.map((n,E)=>e(Ut,{index:E,messages:S,message:n,longPressEvent:Ae},n.id||E))})}),e("div",{className:"attachments",children:M.attachments.map((n,E)=>d("div",{className:"attachment",children:[je(n)?e("video",{src:n,muted:!0,controls:!1,loop:!0,autoPlay:!0}):e(Te,{src:n,blur:!0}),e(De,{onClick:()=>{W({...M,attachments:M.attachments.filter(($,F)=>F!==E)})}})]},E))}),d("div",{className:"message-bottom","data-expanded":!!(k||O),children:[e("div",{className:"upper",children:d("div",{className:"input","data-border":!b,children:[b?d("div",{className:"audio-message",children:[e(De,{onClick:()=>m(null)}),e("div",{className:"audio-waves",children:e("img",{src:b.waves.placeholder})})]}):e(ge,{placeholder:i("APPS.MESSAGES.PLACEHOLDER"),ref:f,value:M.content,onChange:n=>{W({content:n.target.value,attachments:M.attachments})},onKeyDown:n=>{n.key=="Enter"&&ie()}}),(M.content.length>0||M.attachments.length>0||b)&&e("div",{className:"send",onClick:ie,children:e(We,{})})]})}),!k&&!O&&e("div",{className:"actions-wrapper",children:d("div",{className:"actions",children:[e("div",{className:"action",onClick:()=>{if(h)return _.Emoji.reset();_.Emoji.set({onSelect:n=>W(E=>({content:`${E.content}${n.emoji}`,attachments:E.attachments}))})},children:"ðŸ˜€"}),e("div",{className:"action",onClick:()=>{var n,E,$;M.attachments.length<3&&_.Gallery.set({includeVideos:!0,allowExternal:($=(E=(n=q)==null?void 0:n.value)==null?void 0:E.AllowExternal)==null?void 0:$.Messages,onSelect:F=>W({...M,attachments:[...M.attachments,F.src]})})},children:e("img",{src:"./assets/img/icons/messages/gallery.png"})}),C.EnableGIFs!==!1&&e("div",{className:"action small",onClick:()=>{if(c)return _.Gif.reset();_.Gif.set({onSelect:n=>W(E=>({content:E.content,attachments:[...E.attachments??[],n]}))})},children:"GIF"}),(C==null?void 0:C.EnableMessagePay)&&!(a!=null&&a.isGroup)&&e("div",{className:"action ",onClick:()=>{ee(!1),ne(n=>!n)},children:"$"}),e("div",{className:"action",onClick:()=>he(),children:e(at,{})}),(C==null?void 0:C.EnableVoiceMessages)&&e("div",{className:"action",onClick:()=>{ne(!1),ee(n=>!n)},children:e(Ve,{})})]})}),e(ve,{children:k&&e(Dt,{paymentAmount:K,setPaymentAmount:P,close:()=>ne(!1)})}),e(ve,{children:O&&e(Gt,{onEnd:n=>{if(!n)return y("error","Failed to get audio message data");m({blob:n.blob,waves:n.waveform,duration:n.duration}),ee(!1)},close:()=>ee(!1)})})]})]})})}const Ut=({messages:t,message:r,index:g,longPressEvent:A})=>{var w,U;const{User:C}=u.useContext(ue),p=L(z.PhoneNumber),[o]=C,a=L(q);let T,v,G,s,l,S,h=r.sender===p?"self":"other",c=((w=t[g+1])==null?void 0:w.sender)===p?"self":"other";if(t[g+1]?G=Math.abs(r.timestamp-t[g+1].timestamp)/36e5:c=void 0,o!=null&&o.isGroup)T=(U=o.members.find(R=>R.number===r.sender))==null?void 0:U.name,v=!t[g-1]||t[g-1].sender!==r.sender;else if(T=o.name,r.content)if(be(r.content))if(h==="other")r.content=i("APPS.MESSAGES.MISSED_CALL").format({number:r.sender});else return y("info","MessageComponent",`Message ${g} returning null (missed call from self)`),null;else/<!SENT-PAYMENT-(\d*)!>/.test(r.content)?s={amount:r.content.match(/\d/g).join(""),request:!1}:/<!REQUESTED-PAYMENT-(\d*)!>/.test(r.content)&&(s={amount:r.content.match(/\d/g).join(""),request:!0});if(Be(r.content)){let R=r.content.match(/X=(-?\d*\.?\d*)Y/)[1],V=r.content.match(/Y=(-?\d*\.?\d*)!>/)[1];l={x:R,y:V}}return Ot(r.content)&&(S={wave:r.content.match(/AUDIO-MESSAGE-IMAGE="([^"]+)"/)[1],src:r.content.match(/AUDIO="([^"]+)"/)[1],duration:r.content.match(/DURATION="([^"]+)"/)[1]}),d("div",{className:`message ${h}`,"data-id":r.id,...A,children:[v&&h=="other"&&e("div",{className:"user",children:T??j(r.sender)}),r.delivered===!1?d("div",{className:"content-wrapper",children:[s&&e("div",{className:"payment",children:a.CurrencyFormat.replace("%s",s.amount)}),!s&&e("div",{className:"content",children:Le(r.content)}),e(st,{})]}):s||l||S?d(de,{children:[l&&d("div",{className:"location",onClick:()=>{_.ContextMenu.set({buttons:[{title:i("APPS.MESSAGES.OPEN_IN_MAPS"),cb:()=>{se.patch({active:{name:"Maps",data:{location:[l.y,l.x],name:i("APPS.MESSAGES.USERS_LOCATION").format({name:T??j(r.sender)}),icon:o.avatar}}})}},{title:i("APPS.MAPS.SET_WAYPOINT"),cb:()=>{x("Maps",{action:"setWaypoint",data:{x:l.x,y:l.y}})}}]})},children:[e(kt,{location:[parseFloat(l.y),parseFloat(l.x)]}),h==="other"&&d("div",{className:"sender",children:[T??j(r.sender)," ",i("APPS.MESSAGES.SENT_LOCATION")]})]}),s&&e("div",{className:"payment",children:s.request?d("div",{className:we("request",h),children:[d("div",{className:"title",children:[a.CurrencyFormat.replace("%s",Ue(s.amount).toString())," ",i("APPS.MESSAGES.PAY.REQUESTED")]}),h==="other"&&e("div",{className:"button",onClick:()=>qe(s.amount,{id:o.id,number:o.number,name:o.name}),children:i("APPS.MESSAGES.PAY.PAY")})]}):e("div",{className:"sent",children:a.CurrencyFormat.replace("%s",Ue(s.amount).toString())})}),S&&e(_t,{data:S,sender:h})]}):r.content&&e("div",{className:"content",children:Le(r.content)}),r.attachments&&r.attachments.length>0&&e("div",{className:"attatchments",children:r.attachments.map((R,V)=>je(R)?e("video",{src:R,controls:!1,loop:!0,autoPlay:!0,muted:!0,onClick:O=>_.FullscreenImage.set(R)},V):e(Te,{src:R,blur:!0,onClick:()=>_.FullscreenImage.set(R)},V))}),r.delivered===!1?e("div",{className:"status",children:i("APPS.MESSAGES.NOT_DELIVERED")}):t[g+1]&&G>6?e("div",{className:"date",children:_e(r.timestamp)}):h!==c&&e("div",{className:"date",children:_e(r.timestamp)})]},g)},_t=({data:t,sender:r})=>{var T;const[g,A]=u.useState(!1),[C,p]=u.useState(0),o=u.useRef(null);u.useEffect(()=>{o.current&&(o.current.onended=()=>A(!1))},[o]);const a=v=>{v=Math.floor(v);const G=Math.floor(v/60),s=v-G*60;return`${G<10?"0"+G:G}:${s<10?"0"+s:s}`};return d("div",{className:`voice-message ${r}`,children:[e("a",{onClick:()=>{o.current&&(g?(o.current.pause(),o.current.currentTime=0):o.current.play().catch(()=>y("error","Failed to play audio message")),A(v=>!v))},children:g?e(nt,{}):e(rt,{})}),d("div",{className:"wave",children:[e("div",{className:"overlay",style:{width:`${(t.duration-C)/t.duration*100}%`}}),e("img",{src:t.wave,alt:"wave"})]}),e("div",{className:"duration",children:a(g&&Math.floor(((T=o.current)==null?void 0:T.currentTime)+.5)!==0?o.current.currentTime:t.duration)}),e("audio",{ref:o,onTimeUpdate:v=>p(v.currentTarget.currentTime),children:e("source",{src:t.src,type:"audio/mpeg"})})]})},$t=({user:t,setShow:r})=>{const g=L(z.Settings);return d(J.div,{...Oe,className:"info-panel",children:[e("div",{className:"info-panel-header",children:e("div",{className:"done",onClick:()=>r(!1),children:i("APPS.MESSAGES.DONE")})}),d("div",{className:"info-panel-body",children:[d("div",{className:"info-panel-top",children:[e("div",{className:"avatar","data-hasavatar":(t==null?void 0:t.avatar)!==void 0,style:{backgroundImage:t!=null&&t.avatar?`url(${t.avatar})`:null},children:t.name?!(t!=null&&t.avatar)&&Se(t.name):e("img",{src:`./assets/img/avatar-placeholder-${g.display.theme}.svg`,alt:""})}),e("div",{className:"name",children:t.name??j(t.number)})]}),e("div",{className:"items",children:!t.company&&d(de,{children:[t.name&&e("div",{className:"info-section",children:e("div",{className:"item blue",onClick:()=>it(t.number),children:j(t.number)})}),e("div",{className:"info-section",children:t.name?e("div",{className:"item blue",onClick:()=>{_.Share.set({type:"contact",data:{firstname:t.firstname,lastname:t.lastname,number:t.number,avatar:t.avatar}})},children:i("APPS.PHONE.CONTACTS.SHARE_CONTACT")}):e("div",{className:"item blue",onClick:()=>{se.patch({active:{name:"Phone",data:{view:"newContact",number:t.number}}})},children:i("APPS.PHONE.CONTACTS.ADD_CONTACT")})})]})})]})]})},xt=t=>{const{View:r}=u.useContext(ue),g=L(z.Settings),[A,C]=r,[p,o]=u.useState(t.data.name),[a,T]=u.useState(t.data.avatar);let v=t.data,G=!v.members.find(s=>s.isOwner);return e(de,{children:d(J.div,{...Oe,className:"info-panel",children:[d("div",{className:"info-panel-header",children:[e("div",{}),e("div",{className:"close",children:e("div",{className:"button",onClick:()=>t.setShow(!1)})}),e("div",{className:"done",onClick:()=>{p&&p!==""&&p!==v.name?x("Messages",{action:"renameGroup",id:v.id,name:p}).then(s=>{t.setShow(!1)}):t.setShow(!1)},children:i("APPS.MESSAGES.DONE")})]}),d("div",{className:"info-panel-body",children:[d("div",{className:"info-panel-top",children:[a?e(Te,{className:"group-image",src:a,blur:!0}):d("div",{className:"group-avatar",children:[v.members.sort((s,l)=>s.avatar?1:-1).slice(0,5).map((s,l)=>e("div",{className:"avatar","data-hasavatar":(s==null?void 0:s.avatar)!==void 0,style:{backgroundImage:s!=null&&s.avatar?`url(${s.avatar})`:null,zIndex:v.members.length-l},children:s.name?!(s!=null&&s.avatar)&&Se(s.name):e("img",{src:`./assets/img/avatar-placeholder-${g.display.theme}.svg`,alt:""})},l)),v.members.length===0&&e("img",{src:`./assets/img/avatar-placeholder-${g.display.theme}.svg`,alt:""})]}),e("div",{className:"add-photo",onClick:()=>{var s,l,S;a?_.PopUp.set({title:i("APPS.MESSAGES.REMOVE_AVATAR_POPUP.TITLE"),description:i("APPS.MESSAGES.REMOVE_AVATAR_POPUP.DESCRIPTION"),buttons:[{title:i("APPS.MESSAGES.REMOVE_AVATAR_POPUP.CANCEL")},{title:i("APPS.MESSAGES.REMOVE_AVATAR_POPUP.REMOVE"),color:"red",cb:()=>{x("Messages",{action:"removeGroupAvatar",id:v.id},!0).then(h=>{if(!h)return y("warning","Could not remove group avatar");t.setData(c=>{let w=c;return w.avatar=null,w}),T(null)})}}]}):_.Gallery.set({allowExternal:(S=(l=(s=q)==null?void 0:s.value)==null?void 0:l.AllowExternal)==null?void 0:S.Messages,onSelect:h=>x("Messages",{action:"setGroupAvatar",id:v.id,avatar:h.src},!0).then(c=>{if(!c)return y("warning","Could not set group avatar");t.setData(w=>{let U=w;return U.avatar=h.src,U}),T(h.src)})})},children:a?"Remove Photo":" Add Photo"})]}),d("div",{className:"items",children:[e("div",{className:"info-section",children:d("div",{className:"item blue",children:[e(lt,{className:"add"}),e(ge,{defaultValue:v.name??i("APPS.MESSAGES.GROUP_NAME"),onChange:s=>o(s.target.value)})]})}),d("div",{className:"subtitle",children:[v.members.length===0?1:v.members.length," ",i("APPS.MESSAGES.MEMBERS")]}),d("div",{className:"info-section",children:[d("div",{className:"item",onClick:()=>_.ContactSelector.set({filter:v.members.map(s=>s.number),onSelect:s=>{if(v.members.find(l=>l.number===s.number))return y("info","User is already in group");x("Messages",{action:"addMember",id:v.id,number:s.number},!0).then(l=>{if(!l)return y("warning","Could not add member to group");t.setData(S=>{let h=S;return h.members.push({...s,name:re(s.firstname,s.lastname),isOwner:!1}),h})})}}),children:[e(ot,{className:"add"}),e("div",{className:"name",children:i("APPS.MESSAGES.ADD_MEMBER")})]}),v.members.sort((s,l)=>s.name&&!l.name?-1:!s.name&&l.name?1:s.name<l.name?-1:s.name>l.name?1:0).map((s,l)=>d("div",{className:"item",children:[G&&e(ct,{className:"remove",onClick:()=>{_.PopUp.set({title:i("APPS.MESSAGES.REMOVE_POPUP.TITLE"),description:i("APPS.MESSAGES.REMOVE_POPUP.TEXT").format({name:s.name??j(s.number)}),buttons:[{title:i("APPS.MESSAGES.CANCEL")},{title:i("APPS.MESSAGES.REMOVE_POPUP.REMOVE"),color:"red",cb:()=>{x("Messages",{action:"removeMember",number:s.number,id:v.id}).then(S=>{S&&(t.setData(h=>{let c=h;return c.members=c.members.filter(w=>w.number!==s.number),c}),t.setShow(!1))})}}]})}}),e("div",{className:"avatar","data-hasavatar":(s==null?void 0:s.avatar)!==void 0,style:{backgroundImage:s!=null&&s.avatar?`url(${s.avatar})`:null},children:s.name?!(s!=null&&s.avatar)&&Se(s.name):e("img",{src:`./assets/img/avatar-placeholder-${g.display.theme}.svg`,alt:""})}),d("div",{className:"details",children:[e("div",{className:"name",children:s.name??j(s.number)}),s.name&&e("div",{className:"phone-number",children:j(s.number)})]}),e(dt,{className:"info",onClick:()=>t.setShowUserInfo({...s})})]},l))]}),e("div",{className:"info-section",children:e("div",{className:"item blue",onClick:()=>t.sendLocation(),children:i("APPS.MESSAGES.SHARE_LOCATION")})}),e("div",{className:"info-section",onClick:()=>{_.PopUp.set({title:i("APPS.MESSAGES.LEAVE_POPUP.TITLE"),description:i("APPS.MESSAGES.LEAVE_POPUP.TEXT"),buttons:[{title:i("APPS.MESSAGES.CANCEL")},{title:i("APPS.MESSAGES.LEAVE_POPUP.LEAVE"),color:"red",cb:()=>{x("Messages",{action:"leaveGroup",id:v.id}).then(s=>{if(!s)return y("info","Failed to leave group, server didnt callback request");C("userlist"),t.setShow(!1)})}}]})},children:d("div",{className:"item red",children:[e(ut,{}),i("APPS.MESSAGES.LEAVE_GROUP")]})})]})]})]})})};function Vt(){const{User:t,View:r,Newmessage:g,ImportedUser:A}=u.useContext(ue),[C,p]=t,[o,a]=r,[T,v]=A,G=L(z.Settings),s=L(z.PhoneNumber),[l,S]=g,h=L(H.APPS.PHONE.contacts),[c,w]=u.useState([]),U=u.useRef(null),[R,V]=u.useState(""),[O,ee]=u.useState([]),[k,ne]=u.useState({content:"",attachments:[]});u.useEffect(()=>{T&&(w([T]),v(null))},[T]);const K=()=>{(k.content.length>0||k.attachments.length>0)&&(c.length>1?x("Messages",{action:"createGroup",members:c,content:k.content,attachments:k.attachments}).then(P=>{if(!P)return y("error","Failed to create group");p({id:P.channelId,lastMessage:k.content,timestamp:Date.now(),isGroup:!0,members:c.map(b=>{let m=re(b.firstname,b.lastname);return{...b,name:m}})}),a("messages"),S(!1)}):x("Messages",{action:"sendMessage",number:c[0].number,content:k.content,attachments:k.attachments}).then(P=>{var f,D,N,M;if(!P){y("error","Failed to send message"),_.PopUp.set({title:i("APPS.MESSAGES.FAILED_SEND.TITLE"),description:i("APPS.MESSAGES.FAILED_SEND.DESCRIPTION"),buttons:[{title:i("APPS.MESSAGES.FAILED_SEND.OK")}]});return}let b;c[0].name?b=c[0].name:(f=c[0])!=null&&f.firstname&&(b=re((D=c[0])==null?void 0:D.firstname,(N=c[0])==null?void 0:N.lastname));let m={number:c[0].number,name:b,avatar:(M=c[0])==null?void 0:M.avatar};p({...m,id:P.channelId,lastMessage:k.content,timestamp:Date.now()}),y("info","Updating recent message cache state"),H.APPS.MESSAGES.messages.set(H.APPS.MESSAGES.messages.value.map(W=>W.id===P.channelId?{...W,timestamp:new Date().getTime(),lastMessage:k.content,unread:!1,deleted:!1}:W)),a("messages"),S(!1)}))};return u.useEffect(()=>{if(R.length>0){if(!h)return y("error","Contacts not loaded");ee(h.filter(P=>{let b=re(P.firstname,P.lastname);return b&&(b==null?void 0:b.toLowerCase().includes(R==null?void 0:R.toLowerCase()))&&!P.company}))}else ee([])},[R]),d(J.div,{...Oe,className:"new-message-container",children:[d("div",{className:"new-message-header",children:[e("span",{}),e("div",{className:"title",children:i("APPS.MESSAGES.NEW_MESSAGE")}),e("div",{className:"button",onClick:()=>{var b,m,f;c.length>0&&(k.content.length>0||k.attachments.length>0)?K():(S(!1),(f=(m=(b=se)==null?void 0:b.value)==null?void 0:m.active)!=null&&f.data&&se.patch({active:{...se.value.active,data:null}}))},children:c.length>0&&(k.content.length>0||k.attachments.length>0)?i("APPS.MESSAGES.SEND"):i("APPS.MESSAGES.CANCEL")})]}),d("div",{className:"new-message-body",children:[d("div",{className:"new-message-search",children:[d("div",{className:"to",children:[i("APPS.MESSAGES.TO"),":"]}),e("div",{className:"contacts",children:c.map((P,b)=>{let m=re(P.firstname,P.lastname),f=m!=="Unknown";return e("div",{className:we("contact",f?"green":"blue"),onClick:()=>{_.PopUp.set({title:i("APPS.MESSAGES.REMOVE_POPUP.TITLE"),description:i("APPS.MESSAGES.REMOVE_POPUP.TEXT").format({NAME:m??j(P.number)}),buttons:[{title:i("APPS.MESSAGES.CANCEL")},{title:i("APPS.MESSAGES.REMOVE_POPUP.REMOVE"),color:"red",cb:()=>{let D=c.filter(N=>N.number!==P.number);w(D)}}]})},children:f?m:j(P.number)},b)})}),e(ge,{type:"text",ref:U,onChange:P=>{if(V(P.target.value),P.target.value.length==s.length&&/^\d+$/g.test(P.target.value)){if(P.target.value===s||c.find(m=>m.number==P.target.value))return;w([...c,{number:P.target.value}]),U.current.value="",V("")}},onKeyDown:P=>{var b;P.key=="Backspace"&&R.length==0?((b=c[c.length-1])==null?void 0:b.name)===void 0?(U.current.value=c[c.length-1].number,w(c.slice(0,c.length-1))):w(c.slice(0,-1)):P.key=="Tab"&&(P.preventDefault(),O.length==1&&(w([...c,O[0]]),U.current.value="",V("")))}})]}),e("div",{className:"search-results",children:O&&O.filter(P=>!c.find(b=>b.number==P.number)).map((P,b)=>{let m=re(P.firstname,P.lastname);return d("div",{className:"contact",onClick:()=>{c.find(D=>D.number==P.number)||(w([...c,P]),U.current.value="",V(""))},children:[e("img",{src:P.avatar??`./assets/img/avatar-placeholder-${G.display.theme}.svg`}),d("div",{className:"user",children:[e("div",{className:"name",children:m}),e("div",{className:"number",children:j(P.number)})]})]},b)})})]}),c.length>0&&O.length===0&&e("div",{className:"message-bottom absolute",children:e("div",{className:"upper",children:d("div",{className:"input",children:[e(ge,{placeholder:i("APPS.MESSAGES.PLACEHOLDER"),value:k.content,onChange:P=>{ne({content:P.target.value??"",attachments:k.attachments})},onKeyDown:P=>{P.key=="Enter"&&K()}}),(k.content.length>0||k.attachments.length>0)&&e("div",{className:"send",onClick:()=>K(),children:e(We,{})})]})})})]})}const ae=Ie([]),ce=Ie([]);function Ft(){var b;const{User:t,View:r,Newmessage:g,UnreadMessages:A,ImportedUser:C}=u.useContext(ue),p=L(z.PhoneNumber),o=(b=L(se))==null?void 0:b.active,[a,T]=t,[v,G]=r,[s,l]=C,[S,h]=g,[c,w]=A,U=L(H.APPS.PHONE.contacts),R=L(H.APPS.MESSAGES.messages),V=L(ae),[O,ee]=u.useState(""),[k,ne]=u.useState(!1),K=L(ce);u.useEffect(()=>{if(Fe("Messages"))if(R)y("info","Using cache for recent messages"),w(V.filter(m=>m.unread).length),ae.set(R.map(m=>{if(!m.name){let f=U.find(D=>D.number===m.number);if(!f)return m;m.name=re(f.firstname,f.lastname),m.avatar=f==null?void 0:f.avatar}return m})??[]);else{if(!Ce())return y("info","No service, not fetching recent messages");x("Messages",{action:"getRecentMessages"},Xe.Messagelist).then(m=>{if(!m)return y("error","No recent messages");let f=m.map(D=>{if(D.isGroup)return D.members=D.members.filter(N=>N.number!==p).map(N=>{let M=U.find(W=>W.number===N.number);return{name:M&&M.firstname?re(M==null?void 0:M.firstname,M==null?void 0:M.lastname):void 0,avatar:M==null?void 0:M.avatar,blocked:M==null?void 0:M.blocked,favourite:M==null?void 0:M.favourite,number:N.number,isOwner:N.isOwner}}),D;{let N=U.find(M=>M.number===D.number);return D.name=N!=null&&N.lastname?`${N.firstname} ${N.lastname}`:N==null?void 0:N.firstname,D.avatar=N==null?void 0:N.avatar,D}});w(f.filter(D=>D.unread).length),ae.set(f),y("info","setting cache"),H.APPS.MESSAGES.messages.set(f)})}},[R,o]);let P=u.useRef(!1);return u.useEffect(()=>{var m;if(!P.current&&o!=null&&o.data&&(P.current=!0,o!=null&&o.data&&((m=o.data)==null?void 0:m.view)=="messages")){let f=V==null?void 0:V.find(D=>D.number===o.data.number);f?(T(f),G("messages")):(h(!0),l({number:o.data.number,name:o.data.name,avatar:o.data.avatar}))}},[o==null?void 0:o.data,V]),fe("messages:newMessage",m=>{let f=JSON.parse(JSON.stringify(ae.value)),D=f.findIndex(N=>N.id===m.channelId);if(D!==-1&&f.unshift(f.splice(D,1)[0]),f.length===0)return y("error","No recent messages");f[0].lastMessage=m.content,f[0].timestamp=new Date,ae.set(f)},{waitUntilService:!0}),d(de,{children:[e(ve,{children:S&&e(Vt,{})}),d(J.div,{...He("left","messagelist",.2),className:"animation-container",children:[d("div",{className:"messages-header",children:[d("div",{className:"buttons",children:[e("div",{className:"edit",onClick:()=>ne(!k),children:k?i("APPS.MESSAGES.DONE"):i("APPS.MESSAGES.EDIT")}),e(mt,{"data-disabled":k,onClick:()=>h(!0)})]}),e("div",{className:"title",children:i("APPS.MESSAGES.TITLE")})]}),e(St,{placeholder:i("SEARCH"),onChange:m=>ee(m.target.value)}),e("div",{className:"users-list",children:V.filter(m=>{var f,D,N,M,W,ie,he,X,B;return m.deleted?!1:(m.isGroup?m.members.find(Q=>{var me,Ae,Pe,n,E;return Q&&(((n=(Ae=(me=Q.name)==null?void 0:me.toLowerCase)==null?void 0:Ae.call(me))==null?void 0:n.includes((Pe=O==null?void 0:O.toLowerCase)==null?void 0:Pe.call(O)))||((E=Q==null?void 0:Q.number)==null?void 0:E.includes(O)))}):((M=(D=(f=m.name)==null?void 0:f.toLowerCase)==null?void 0:D.call(f))==null?void 0:M.includes((N=O==null?void 0:O.toLowerCase)==null?void 0:N.call(O)))||((W=m.number)==null?void 0:W.includes(O)))||((B=(he=(ie=m==null?void 0:m.lastMessage)==null?void 0:ie.toLowerCase)==null?void 0:he.call(ie))==null?void 0:B.includes((X=O==null?void 0:O.toLowerCase)==null?void 0:X.call(O)))}).sort((m,f)=>f.timestamp-m.timestamp).map((m,f)=>e(Yt,{user:m,editMode:k,onClick:()=>{if(T(m),G("messages"),m.unread){x("Messages",{action:"markRead",id:m.id},!0),w(N=>N-1);let D=H.APPS.MESSAGES.messages.value;H.APPS.MESSAGES.messages.set(D.map(N=>(N.id===m.id&&(N.unread=!1),N)))}}},f))}),e(ve,{children:k&&d(J.div,{initial:{opacity:0,y:50},animate:{opacity:1,y:0},exit:{opacity:0,y:50},transition:{duration:.2,ease:"easeInOut"},className:"messages-footer",children:[e("div",{className:"button","data-disabled":!0,children:i("APPS.MESSAGES.READ")}),e("div",{className:"button",onClick:()=>{if(K.length===0)return y("info","No messages selected, can't delete");_.PopUp.set({title:i("APPS.MESSAGES.DELETE_CONVERSATION.TITLE"),description:i("APPS.MESSAGES.DELETE_CONVERSATION.DESCRIPTION"),buttons:[{title:i("APPS.MESSAGES.CANCEL")},{title:i("APPS.MESSAGES.DELETE"),cb:()=>{x("Messages",{action:"deleteConversations",channels:K},!0).then(m=>{if(!m)return y("error","Failed to delete conversations");ne(!1),ae.set(V.filter(f=>!K.includes(f.id))),H.APPS.MESSAGES.messages.set([...H.APPS.MESSAGES.messages.value.map(f=>(K.includes(f.id)&&(f.deleted=!0),f))]),ce.set([])})}}]})},children:i("APPS.MESSAGES.DELETE")})]})})]})]})}const Yt=({user:t,editMode:r,onClick:g})=>{var G,s;const A=L(q),C=L(z.Settings),p=L(ae),[o,a]=u.useState(!1);let T;const v=Ye(l=>{_.ContextMenu.set({buttons:[{title:i("APPS.MESSAGES.MARK_AS_READ"),cb:()=>{x("Messages",{action:"markRead",id:t.id},!0).then(S=>{if(!S)return y("error","Failed to mark message as read");ae.set(p.map(c=>(c.id===t.id&&(c.unread=!1),c)));let h=H.APPS.MESSAGES.messages.value;H.APPS.MESSAGES.messages.set(h.map(c=>(c.id===t.id&&(c.unread=!1),c)))})}},{title:i("APPS.MESSAGES.DELETE_CONVERSATION.TITLE"),color:"red",cb:()=>{_.PopUp.set({title:i("APPS.MESSAGES.DELETE_CONVERSATION.TITLE"),description:i("APPS.MESSAGES.DELETE_CONVERSATION.DESCRIPTION"),buttons:[{title:i("APPS.MESSAGES.CANCEL")},{title:i("APPS.MESSAGES.DELETE"),cb:()=>{x("Messages",{action:"deleteConversations",channels:[t.id]},!0).then(S=>{if(!S)return y("error","Failed to delete conversations");ae.set(p.filter(h=>h.id!==t.id)),H.APPS.MESSAGES.messages.set([...H.APPS.MESSAGES.messages.value.map(h=>(h.id===t.id&&(h.deleted=!0),h))]),ce.set([])})}}]})}}]})});if(t.isGroup)if(t.name)T=t.name;else if(t.members.length===0)T=i("APPS.MESSAGES.GROUP");else{let l=t.members.length-1;T=t.members.sort((S,h)=>S.name&&!h.name?-1:!S.name&&h.name?1:S.name<h.name?-1:S.name>h.name?1:0).slice(0,2).map((S,h)=>{var w,U;let c=S.name?S.name:j(S.number);return h===1&&l>2?`${c} +${l} ${(U=(w=i("APPS.MESSAGES.OTHER"))==null?void 0:w.toLowerCase)==null?void 0:U.call(w)}`:c}).join(", ")}else T=t.name;if(t.lastMessage){if(t.lastMessage==="Attachment"&&(t.lastMessage=i("APPS.MESSAGES.SENT_A_PHOTO")),/<!SENT-PAYMENT-(\d*)!>/.test(t.lastMessage)){let l=t.lastMessage.match(/\d/g).join("");t.lastMessage=`${i("APPS.MESSAGES.SENT")} ${A.CurrencyFormat.replace("%s",l)}`}else if(/<!REQUESTED-PAYMENT-(\d*)!>/.test(t.lastMessage)){let l=t.lastMessage.match(/\d/g).join("");t.lastMessage=`${i("APPS.MESSAGES.REQUESTED")} $${l}`}else if(/<!SENT-LOCATION-X=(-?\d*\.?\d*)Y=(-?\d*\.?\d*)!>/.test(t.lastMessage))t.lastMessage=`${i("APPS.MESSAGES.SENT_LOCATION_SHORT")}`;else if(t.lastMessage.startsWith('<!AUDIO-MESSAGE-IMAGE="'))t.lastMessage=i("APPS.MESSAGES.SENT_AUDIO_MESSAGE");else if(t.lastMessage==="<!CALL-NO-ANSWER!>")t.lastMessage=i("APPS.MESSAGES.TRIED_TO_CALL").format({number:j(t.number)});else if(t.lastMessage==="")return}return u.useEffect(()=>{o?ce.set([...ce.value,t.id]):ce.set(ce.value.filter(l=>l!==t.id))},[o]),d(J.div,{initial:{opacity:0,scale:.9},whileInView:{opacity:1,scale:1},viewport:{once:!0},className:"user",...v,onClick:()=>{r?a(!o):g()},children:[d("div",{className:"items",children:[r&&e(J.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.9},className:"check","data-checked":o,onClick:l=>{l.stopPropagation(),a(!o)},children:o&&e(ht,{})},"check"),e("div",{className:we("dot",t.unread&&"unread")})]}),t.isGroup?d("div",{className:"avatar group",children:[t.members.map((l,S)=>{var h;if(S<=3)return l.avatar?e("div",{"data-hasavatar":"true",style:{backgroundImage:`url(${l.avatar})`}},S):l.name?e("div",{children:(h=l==null?void 0:l.name)==null?void 0:h.charAt(0)},S):e("div",{className:"unknown"},S)}),t.members.length===0&&e("img",{className:"avatar",src:`assets/img/avatar-placeholder-${C.display.theme}.svg`})]}):e("div",{className:"avatar",style:{backgroundImage:t!=null&&t.avatar?`url(${t.avatar})`:null},children:t.name?!(t!=null&&t.avatar)&&Se(t.name):e("img",{src:`assets/img/avatar-placeholder-${C.display.theme}.svg`,alt:""})}),d("div",{className:"user-body",children:[d("div",{className:"user-header",children:[e("div",{className:"name",children:T??j(t.number)}),d("div",{className:"right",children:[e("div",{className:"time",children:Et(t.timestamp)}),e(ft,{})]})]}),e("div",{className:"content",children:((G=t.lastMessage)==null?void 0:G.length)>40?((s=t.lastMessage)==null?void 0:s.substring(0,40))+"...":t.lastMessage})]})]})};const ue=u.createContext(null);function Bt(){const[t,r]=u.useState(null),[g,A]=u.useState("userlist"),[C,p]=u.useState(null),[o,a]=u.useState(0),[T,v]=u.useState(!1);return e("div",{className:"messages-container","data-view":g,children:e(ue.Provider,{value:{User:[t,r],View:[g,A],Newmessage:[T,v],ImportedUser:[C,p],UnreadMessages:[o,a]},children:g==="userlist"?e(Ft,{}):t&&e(Lt,{})})})}export{ue as MessagesContext,Bt as default};
